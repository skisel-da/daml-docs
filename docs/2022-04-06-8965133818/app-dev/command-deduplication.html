<!-- Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Command deduplication &mdash; Daml SDK 0.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
  
  <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
  <script src="../_static/jquery.js"></script>
  <script src="../_static/underscore.js"></script>
  <script src="../_static/doctools.js"></script>
  <script src="../_static/clipboard.min.js"></script>
  <script src="../_static/copybutton.js"></script>
  
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="next" title="Daml Triggers - Off-Ledger Automation in Daml" href="../triggers/index.html" />
  <link rel="prev" title="Creating your own bindings" href="bindings-x-lang/index.html" /> 

  
  <link rel="icon" type="image/svg+xml"  href="../_static/images/daml-logo-mark-light.svg">
  <link rel="alternate icon" href="../_static/images/daml-favicon-1.ico">

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MSWJMNX');</script>
  <!-- End Google Tag Manager -->

  
  <!-- Mopinion Pastea.se  start --><script type="text/javascript">(function(){var id="4s6vwov7ad6qyxhq8iwbyhocrsn2nm36k25";var js=document.createElement("script");js.setAttribute("type","text/javascript");js.setAttribute("src","//deploy.mopinion.com/js/pastease.js");js.async=true;document.getElementsByTagName("head")[0].appendChild(js);var t=setInterval(function(){try{new Pastease.load(id);clearInterval(t)}catch(e){}},50)})();</script><!-- Mopinion Pastea.se end -->
</head>

<body class="wy-body-for-nav">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MSWJMNX"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-nav-side-shadow"></div>
      <div class="wy-side-scroll">

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
          
          
          
          
          
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Daml Documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation.html">Installing the SDK</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/path-variables.html">Setting JAVA_HOME and PATH Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/manual-download.html">Manually Installing the SDK</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Building Your App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/app-architecture.html">App Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-feature.html">Your First Feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/testing.html">Testing Your Web App</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.daml.com/cheat-sheet">Cheat Sheet</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Writing Daml</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../writing-daml.html">Writing Daml</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/0_Intro.html">An introduction to Daml</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/1_Token.html">1 Basic contracts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/2_DamlScript.html">2 Testing templates using Daml Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/3_Data.html">3 Data types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/4_Transformations.html">4 Transforming data using choices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/5_Restrictions.html">5 Adding constraints to a contract</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/6_Parties.html">6 Parties and authority</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/7_Composing.html">7 Composing choices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/8_Exceptions.html">8 Exception Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/9_Dependencies.html">9 Working with Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/10_Functional101.html">10 Functional Programming 101</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/11_StdLib.html">11 Intro to the Daml Standard Library</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/intro/12_Testing.html">12 Testing Daml Contracts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/index.html">Language reference docs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/structure.html">Overview: template structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/templates.html">Templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/choices.html">Choices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/updates.html">Updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/data-types.html">Data types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/working-with.html">Built-in functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/expressions.html">Expressions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/functions.html">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/file-structure.html">File structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/packages.html">Packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/contract-keys.html">Contract keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/exceptions.html">Exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/reference/interfaces.html">Interfaces</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../daml/stdlib/index.html">The standard library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/Prelude.html">Prelude</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Action.html">DA.Action</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Action-State.html">DA.Action.State</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Action-State-Class.html">DA.Action.State.Class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Assert.html">DA.Assert</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Bifunctor.html">DA.Bifunctor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-BigNumeric.html">DA.BigNumeric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Date.html">DA.Date</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Either.html">DA.Either</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Exception.html">DA.Exception</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Foldable.html">DA.Foldable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Functor.html">DA.Functor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-List.html">DA.List</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-List-BuiltinOrder.html">DA.List.BuiltinOrder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-List-Total.html">DA.List.Total</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Logic.html">DA.Logic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Map.html">DA.Map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Math.html">DA.Math</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Monoid.html">DA.Monoid</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-NonEmpty.html">DA.NonEmpty</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-NonEmpty-Types.html">DA.NonEmpty.Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Numeric.html">DA.Numeric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Optional.html">DA.Optional</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Record.html">DA.Record</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Semigroup.html">DA.Semigroup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Set.html">DA.Set</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Stack.html">DA.Stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Text.html">DA.Text</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-TextMap.html">DA.TextMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Time.html">DA.Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Traversable.html">DA.Traversable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Tuple.html">DA.Tuple</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/stdlib/DA-Validation.html">DA.Validation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns.html">Good design patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/initaccept.html">Initiate and Accept</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/multiparty-agreement.html">Multiple party agreement</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/delegation.html">Delegation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/authorization.html">Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking.html">Locking</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../daml/patterns/locking/locking-by-archiving.html">Locking by archiving</a></li>
<li class="toctree-l4"><a class="reference internal" href="../daml/patterns/locking/locking-by-state.html">Locking by state</a></li>
<li class="toctree-l4"><a class="reference internal" href="../daml/patterns/locking/locking-by-safekeeping.html">Locking by safekeeping</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/legends.html">Diagram legends</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Building applications</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../building-applications.html">Building Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="app-arch.html">Application architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="bindings-ts/index.html">JavaScript Client Libraries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="bindings-ts/daml2js.html">JavaScript Code Generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="bindings-ts/daml-react.html">&#64;daml/react</a></li>
<li class="toctree-l3"><a class="reference internal" href="bindings-ts/daml-ledger.html">&#64;daml/ledger</a></li>
<li class="toctree-l3"><a class="reference internal" href="bindings-ts/daml-types.html">&#64;daml/types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../json-api/index.html">HTTP JSON API Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../json-api/lf-value-specification.html">Daml-LF JSON Encoding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../json-api/search-query-language.html">Query language</a></li>
<li class="toctree-l3"><a class="reference internal" href="../json-api/production-setup.html">Production Setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../daml-script/index.html">Daml Script</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../daml-script/api/index.html">Daml Script Library</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../daml-script/api/Daml-Script.html">Daml.Script</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../daml-repl/index.html">Daml REPL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../upgrade/index.html">Upgrading and Extending Daml applications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../upgrade/extend.html">Extending Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../upgrade/upgrade.html">Upgrading Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../upgrade/automation.html">Automating the Upgrade Process</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="ledger-api.html">The Ledger API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="services.html">The Ledger API services</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc/index.html">gRPC</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc/error-codes.html">Error Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc/proto-docs.html">Ledger API Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc/daml-to-ledger-api.html">How Daml types are translated to protobuf</a></li>
<li class="toctree-l3"><a class="reference internal" href="daml-lf-translation.html">How Daml types are translated to Daml-LF</a></li>
<li class="toctree-l3"><a class="reference internal" href="bindings-java/index.html">Java bindings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="bindings-java/codegen.html">Generate Java code from Daml</a></li>
<li class="toctree-l4"><a class="reference internal" href="bindings-java/example.html">Ping Pong Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="bindings-java/quickstart.html">Iou Quickstart Tutorial</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="bindings-x-lang/index.html">Creating your own bindings</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Command deduplication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../triggers/index.html">Daml Triggers - Off-Ledger Automation in Daml</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../triggers/api/index.html">Daml Trigger Library</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../triggers/api/Daml-Trigger.html">Daml.Trigger</a></li>
<li class="toctree-l4"><a class="reference internal" href="../triggers/api/Daml-Trigger-Assert.html">Daml.Trigger.Assert</a></li>
<li class="toctree-l4"><a class="reference internal" href="../triggers/api/Daml-Trigger-LowLevel.html">Daml.Trigger.LowLevel</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tools/trigger-service/index.html">Trigger Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tools/trigger-service/authorization.html">Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tools/trigger-service/auth0_example.html">Auth0 Example Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tools/auth-middleware/index.html">Auth Middleware</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tools/auth-middleware/oauth2.html">OAuth 2.0 Auth Middleware</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deploying to Daml ledgers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deploying.html">Overview of Daml ledgers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../deploy/generic_ledger.html">Deploying to a generic Daml ledger</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Operating Daml</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../operating-daml.html">Operating Daml</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ops/pruning.html">Participant Pruning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ops/metering.html">Participant Metering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ops/requirements.html">System Requirements</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Developer Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/assistant.html">Daml Assistant (<code class="docutils literal notranslate"><span class="pre">daml</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/daml-studio.html">Daml Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/sandbox.html">Daml Sandbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/navigator/index.html">Navigator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/codegen.html">Daml codegen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/profiler.html">Daml Profiler</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Background concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../concepts/glossary.html">Glossary of concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/ledger-model/index.html">Daml Ledger Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-structure.html">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-integrity.html">Integrity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-privacy.html">Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-daml.html">Daml: Defining Contract Models Compactly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-exceptions.html">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/identity-and-package-management.html">Identity and Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/time.html">Time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/local-ledger.html">Causality and Local Ledgers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://daml.com/examples">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Early Access Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/export/index.html">Ledger Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/visual.html">Visualizing Daml Contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/interoperability.html">Ledger Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/non-repudiation.html">Non-repudiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/connect/index.html">Operating Daml</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ops/connect/helm.html">Daml Helm Chart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ops/connect/auth0.html">Setting Up Auth0</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Daml Ecosystem</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support/overview.html">Daml Ecosystem Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../support/status-definitions.html">Status Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../support/component-statuses.html">Feature and Component Statuses</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../support/releases.html">Releases and Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/compatibility.html">Portability, Compatibility, and Support Durations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/support.html">Getting Help</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../canton-refs.html">Dummy Canton Refs</a></li>
</ul>

          
          
          
          <div class="pdf-download"><a href="../_downloads/DigitalAssetSDK.pdf" download>Download as PDF</a></div>
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <div class="topbar fixed">
        
        <nav class="wy-nav-top" aria-label="top navigation">
          
          <i data-toggle="wy-nav-top" class="wy-nav-top-toggle"></i>
          
        </nav>
        <!-- Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="navbar">
    <h1><img src="../_static/images/Daml_Logo_Blue.svg"></h1>
    <div class="navbar-menu">
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com/developers" role="menuitem" class="da-menu-link">Developers</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com/products" role="menuitem" class="da-menu-link">Products</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com" role="menuitem" class="da-menu-link">Company</a>
        </div>
    </div>
</div>

        <div class="version ">
          <span class="hide-mobile">Version&nbsp;</span><span class="version_switcher_placeholder"></span>
          
        </div>


        <!-- Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->
<div class="search-inline">
    <div id="rtd-search-inline-form" class="wy-form">
        <input type="text" class="search-inline-input" placeholder="Search" name="q">
        <img src="../_static/images/Search.svg" class="search-inline-img"/>
    </div>
    <div class="search-alert">
        Please enter at least 3 letters.
    </div>
    <div id="search-inline-results" class="search-inline-results">
        
    </div>
</div>
          <!-- Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="content-menu collapsed">
    <span class="content-menu-title">In This Section</span>
    <span class="content-menu-expand"></span>
    <div class="content-menu-wrapper">
        
        <!-- Local TOC -->
        <div class="content-menu-toc"><ul>
<li><a class="reference internal" href="#">Command deduplication</a><ul>
<li><a class="reference internal" href="#how-command-deduplication-works">How command deduplication works</a></li>
<li><a class="reference internal" href="#how-to-use-command-deduplication">How to use command deduplication</a><ul>
<li><a class="reference internal" href="#known-processing-time-bounds">Known processing time bounds</a><ul>
<li><a class="reference internal" href="#error-handling">Error handling</a></li>
<li><a class="reference internal" href="#failure-scenarios">Failure scenarios</a></li>
</ul>
</li>
<li><a class="reference internal" href="#unknown-processing-time-bounds">Unknown processing time bounds</a><ul>
<li><a class="reference internal" href="#dedup-unbounded-error-handling">Error handling</a></li>
<li><a class="reference internal" href="#id3">Failure scenarios</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
        
    </div>
</div>
        

      </div>
      <div class="wy-nav-content">
        
        <div class="rst-content">
          
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div itemprop="articleBody">
                
  <div class="section" id="command-deduplication">
<span id="id1"></span><h1>Command deduplication<a class="headerlink" href="#command-deduplication" title="Permalink to this headline">¶</a></h1>
<p>The interaction of a Daml application with the ledger is inherently asynchronous: applications send commands to the ledger, and some time later they see the effect of that command on the ledger.
Many things can fail during this time window:</p>
<ul class="simple">
<li>The application can crash.</li>
<li>The participant node can crash.</li>
<li>Messages can be lost on the network.</li>
<li>The ledger may be slow to respond due to a high load.</li>
</ul>
<p>If you want to make sure that an intended ledger change is not executed twice, your application needs to robustly handle all failure scenarios.
This guide covers the following topics:</p>
<ul class="simple">
<li><a class="reference internal" href="#command-dedup-workings"><span class="std std-ref">How command deduplication works</span></a>.</li>
<li><a class="reference internal" href="#command-dedup-usage"><span class="std std-ref">How applications can effectively use the command deduplication</span></a>.</li>
</ul>
<div class="section" id="how-command-deduplication-works">
<span id="command-dedup-workings"></span><h2>How command deduplication works<a class="headerlink" href="#how-command-deduplication-works" title="Permalink to this headline">¶</a></h2>
<p>The following fields in a command submissions are relevant for command deduplication.
The first three form the <a class="reference internal" href="services.html#change-id"><span class="std std-ref">change ID</span></a> that identifies the intended ledger change.</p>
<ul class="simple">
<li>The union of <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-party"><span class="std std-ref">party</span></a> and <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-act-as"><span class="std std-ref">act_as</span></a> define the submitting parties.</li>
<li>The <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-application-id"><span class="std std-ref">application ID</span></a> identifies the application that submits the command.</li>
<li>The <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-command-id"><span class="std std-ref">command ID</span></a> is chosen by the application to identify the intended ledger change.</li>
<li>The deduplication period specifies the period for which no earlier submissions with the same change ID should have been accepted, as witnessed by a completion event on the <a class="reference internal" href="services.html#command-completion-service"><span class="std std-ref">command completion service</span></a>.
If such a change has been accepted in that period, the current submission shall be rejected.
The period is specified either as a <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-deduplication-duration"><span class="std std-ref">deduplication duration</span></a> or as a <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-deduplication-offset"><span class="std std-ref">deduplication offset</span></a> (inclusive).</li>
<li>The <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-submission-id"><span class="std std-ref">submission ID</span></a> is chosen by the application to identify a specific submission.
It is included in the corresponding completion event so that the application can correlate specific submissions to specific completions.
An application should never reuse a submission ID.</li>
</ul>
<p>The ledger may arbitrarily extend the deduplication period specified in the submission, even beyond the maximum deduplication duration specified in the <a class="reference internal" href="services.html#ledger-configuration-service"><span class="std std-ref">ledger configuration</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The maximum deduplication duration is the length of the deduplication period guaranteed to be supported by the participant.</p>
</div>
<p>The deduplication period chosen by the ledger is the <em>effective deduplication period</em>.
The ledger may also convert a requested deduplication duration into an effective deduplication offset or vice versa.
The effective deduplication period is reported in the command completion event in the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-completion-deduplication-duration"><span class="std std-ref">deduplication duration</span></a> or <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-completion-deduplication-offset"><span class="std std-ref">deduplication offset</span></a> fields.</p>
<p>A command submission is considered a <strong>duplicate submission</strong> if at least one of the following holds:</p>
<ul class="simple">
<li>The submitting participant’s completion service contains a successful completion event for the same <a class="reference internal" href="services.html#change-id"><span class="std std-ref">change ID</span></a> within the <em>effective</em> deduplication period.</li>
<li>The participant or Daml ledger are aware of another command submission in-flight with the same <a class="reference internal" href="services.html#change-id"><span class="std std-ref">change ID</span></a> when they perform command deduplication.</li>
</ul>
<p>The outcome of command deduplication is communicated as follows:</p>
<ul>
<li><p class="first">Command submissions via the <a class="reference internal" href="services.html#command-service"><span class="std std-ref">command service</span></a> indicate the command deduplication outcome as a synchronous gRPC response unless the <a class="reference external" href="https://grpc.io/blog/deadlines/">gRPC deadline</a> was exceeded.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The outcome MAY additionally appear as a completion event on the <a class="reference internal" href="services.html#command-completion-service"><span class="std std-ref">command completion service</span></a>,
but applications using the <a class="reference internal" href="services.html#command-service"><span class="std std-ref">command service</span></a> typically need not process completion events.</p>
</div>
</li>
<li><p class="first">Command submissions via the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">command submission service</span></a> can indicate the outcome as a synchronous gRPC response,
or asynchronously through the <a class="reference internal" href="services.html#command-completion-service"><span class="std std-ref">command completion service</span></a>.
In particular, the submission may be a duplicate even if the command submission service acknowledges the submission with the gRPC status code <code class="docutils literal notranslate"><span class="pre">OK</span></code>.</p>
</li>
</ul>
<p>Independently of how the outcome is communicated, command deduplication generates the following outcomes of a command submission:</p>
<ul>
<li><p class="first">If there is no conflicting submission with the same <a class="reference internal" href="services.html#change-id"><span class="std std-ref">change ID</span></a> on the Daml ledger or in-flight, the completion event and possibly the response convey the result of the submission (success or a gRPC error; <a class="reference internal" href="grpc/error-codes.html"><span class="doc">Error Codes</span></a> explains how errors are communicated).</p>
</li>
<li><p class="first">The gRPC status code <code class="docutils literal notranslate"><span class="pre">ALREADY_EXISTS</span></code> with error code ID <a class="reference internal" href="grpc/error-codes.html#error-code-duplicate-command"><span class="std std-ref">DUPLICATE_COMMAND</span></a> indicates that there is an earlier command completion for the same <a class="reference internal" href="services.html#change-id"><span class="std std-ref">change ID</span></a> within the effective deduplication period.</p>
</li>
<li><p class="first">The gRPC status code <code class="docutils literal notranslate"><span class="pre">ABORTED</span></code> with error code id <a class="reference internal" href="grpc/error-codes.html#error-code-submission-already-in-flight"><span class="std std-ref">SUBMISSION_ALREADY_IN_FLIGHT</span></a> indicates that another submission for the same <a class="reference internal" href="services.html#change-id"><span class="std std-ref">change ID</span></a> was in flight when this submission was processed.</p>
</li>
<li><p class="first">The gRPC status code <code class="docutils literal notranslate"><span class="pre">FAILED_PRECONDITION</span></code> with error code id <a class="reference internal" href="grpc/error-codes.html#error-code-invalid-deduplication-period"><span class="std std-ref">INVALID_DEDUPLICATION_PERIOD</span></a> indicates that the specified deduplication period is not supported.
The fields <code class="docutils literal notranslate"><span class="pre">longest_duration</span></code> or <code class="docutils literal notranslate"><span class="pre">earliest_offset</span></code> in the metadata specify the longest duration or earliest offset that is currently supported on the Ledger API endpoint.
At least one of the two fields is present.</p>
<p>Neither deduplication durations up to the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-ledgerconfiguration-max-deduplication-duration"><span class="std std-ref">maximum deduplication duration</span></a> nor deduplication offsets published within that duration SHOULD result in this error.
Participants may accept longer periods at their discretion.</p>
</li>
<li><p class="first">The gRPC status code <code class="docutils literal notranslate"><span class="pre">FAILED_PRECONDITION</span></code> with error code id <a class="reference internal" href="grpc/error-codes.html#error-code-participant-pruned-data-accessed"><span class="std std-ref">PARTICIPANT_PRUNED_DATA_ACCESSED</span></a>, when specifying a deduplication period represented by an offset, indicates that the specified deduplication offset has been pruned.
The field <code class="docutils literal notranslate"><span class="pre">earliest_offset</span></code> in the metadata specifies the last pruned offset.</p>
</li>
</ul>
<p>For deduplication to work as intended, all submissions for the same ledger change must be submitted via the same participant.
Whether a submission is considered a duplicate is determined by completion events, and by default a participant outputs only the completion events for submissions that were requested via the very same participant.
At this time, only <a class="reference external" href="https://www.digitalasset.com/daml-for-vmware-blockchain/">Daml driver for VMware Blockchain</a> supports command deduplication across participants.</p>
</div>
<div class="section" id="how-to-use-command-deduplication">
<span id="command-dedup-usage"></span><h2>How to use command deduplication<a class="headerlink" href="#how-to-use-command-deduplication" title="Permalink to this headline">¶</a></h2>
<p>To effectuate a ledger change exactly once, the application must resubmit a command if an earlier submission was lost.
However, the application typically cannot distinguish a lost submission from slow submission processing by the ledger.
Command deduplication allows the application to resubmit the command until it is executed and reject all duplicate submissions thereafter.</p>
<p>Some ledger changes can be executed at most once, so no command deduplication is needed for them.
For example, if the submitted command exercises a consuming choice on a given contract ID, this command can be accepted at most once because every contract can be archived at most once.
All duplicate submissions of such a change will be rejected with <a class="reference internal" href="grpc/error-codes.html#error-code-contract-not-active"><span class="std std-ref">CONTRACT_NOT_ACTIVE</span></a>.</p>
<p>In contrast, a <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-createcommand"><span class="std std-ref">Create command</span></a> would create a fresh contract instance of the given <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-createcommand-template-id"><span class="std std-ref">template</span></a> for each submission that reaches the ledger (unless other constraints such as the <a class="reference internal" href="../daml/reference/templates.html#daml-ref-preconditions"><span class="std std-ref">template preconditions</span></a> or contract key uniqueness are violated).
Similarly, an <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-exercisecommand"><span class="std std-ref">Exercise command</span></a> on a non-consuming choice or an <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-exercisebykeycommand"><span class="std std-ref">Exercise-By-Key command</span></a> may be executed multiple times if submitted multiple times.
With command deduplication, applications can ensure such intended ledger changes are executed only once within the deduplication period, even if the application resubmits, say because it considers the earlier submissions to be lost or forgot during a crash that it had already submitted the command.</p>
<div class="section" id="known-processing-time-bounds">
<h3>Known processing time bounds<a class="headerlink" href="#known-processing-time-bounds" title="Permalink to this headline">¶</a></h3>
<p>For this strategy, you must estimate a bound <code class="docutils literal notranslate"><span class="pre">B</span></code> on the processing time and forward clock drifts in the Daml ledger with respect to the application’s clock.
If processing measured across all retries takes longer than your estimate <code class="docutils literal notranslate"><span class="pre">B</span></code>, the ledger change may take effect several times.
Under this caveat, the following strategy works for applications that use the <a class="reference internal" href="services.html#command-service"><span class="std std-ref">Command Service</span></a> or the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">Command Submission</span></a> and <a class="reference internal" href="services.html#command-completion-service"><span class="std std-ref">Command Completion Service</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The bound <code class="docutils literal notranslate"><span class="pre">B</span></code> should be at most the configured <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-ledgerconfiguration-max-deduplication-duration"><span class="std std-ref">maximum deduplication duration</span></a>.
Otherwise you rely on the ledger accepting longer deduplication durations.
Such reliance makes your application harder to port to other Daml ledgers and fragile, as the ledger may stop accepting such extended durations at its own discretion.</p>
</div>
<ol class="arabic" id="dedup-bounded-step-command-id">
<li><p class="first">Choose a command ID for the ledger change, in a way that makes sure the same ledger change is always assigned the same command ID.
Either determine the command ID deterministically (e.g., if your contract payload contains a globally unique identifier, you can use that as your command ID), or choose the command ID randomly and persist it with the ledger change so that the application can use the same command ID in resubmissions after a crash and restart.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure that you assign the same command ID to all command (re-)submissions of the same ledger change.
This is useful for the recovery procedure after an application crash/restart.
After a crash, the application in general cannot know whether it has submitted a set of commands before the crash.
If in doubt, resubmit the commands using the same command ID.
If the commands had been submitted before the crash, command deduplication on the ledger will reject the resubmissions.</p>
</div>
</li>
<li id="dedup-bounded-step-offset"><p class="first">When you use the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">Command Completion Service</span></a>, obtain a recent offset on the completion stream <code class="docutils literal notranslate"><span class="pre">OFF1</span></code>, say the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-completionendrequest"><span class="std std-ref">current ledger end</span></a>.</p>
</li>
<li id="dedup-bounded-step-submit"><p class="first">Submit the command with the following parameters:</p>
<ul>
<li><p class="first">Set the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-command-id"><span class="std std-ref">command ID</span></a> to the chosen command ID from <a class="reference internal" href="#dedup-bounded-step-command-id"><span class="std std-ref">Step 1</span></a>.</p>
</li>
<li><p class="first">Set the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-deduplication-duration"><span class="std std-ref">deduplication duration</span></a> to the bound <code class="docutils literal notranslate"><span class="pre">B</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>It is prudent to explicitly set the deduplication duration to the desired bound <code class="docutils literal notranslate"><span class="pre">B</span></code>,
to guard against the case where a ledger configuration update shortens the maximum deduplication duration.
With the bound <code class="docutils literal notranslate"><span class="pre">B</span></code>, you will be notified of such a problem via an <a class="reference internal" href="grpc/error-codes.html#error-code-invalid-deduplication-period"><span class="std std-ref">INVALID_DEDUPLICATION_PERIOD</span></a> error
if the ledger does not support deduplication durations of length <code class="docutils literal notranslate"><span class="pre">B</span></code> any more.</p>
<p class="last">If you omitted the deduplication period, the currently valid maximum deduplication duration would be used.
In this case, a ledger configuration update could silently shorten the deduplication period and thus invalidate your deduplication analysis.</p>
</div>
</li>
<li><p class="first">Set the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-submission-id"><span class="std std-ref">submission ID</span></a> to a fresh value, e.g., a random UUID.</p>
</li>
<li><p class="first">Set the timeout (gRPC deadline) to the expected submission processing time (Command Service) or submission hand-off time (Command Submission Service).</p>
<p>The <strong>submission processing time</strong> is the time between when the application sends off a submission to the <a class="reference internal" href="services.html#command-service"><span class="std std-ref">Command Service</span></a> and when it receives (synchronously, unless it times out) the acceptance or rejection.
The <strong>submission hand-off time</strong> is the time between when the application sends off a submission to the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">Command Submission Service</span></a> and when it obtains a synchronous response for this gRPC call.
After the RPC timeout, the application considers the submission as lost and enters a retry loop.
This timeout is typically much shorter than the deduplication duration.</p>
</li>
</ul>
</li>
<li id="dedup-bounded-step-await"><p class="first">Wait until the RPC call returns a response.</p>
<ul>
<li><p class="first">Status codes other than <code class="docutils literal notranslate"><span class="pre">OK</span></code> should be handled according to <a class="reference internal" href="#dedup-bounded-error-handling"><span class="std std-ref">error handling</span></a>.</p>
</li>
<li><p class="first">When you use the <a class="reference internal" href="services.html#command-service"><span class="std std-ref">Command Service</span></a> and the response carries the status code <code class="docutils literal notranslate"><span class="pre">OK</span></code>, the ledger change took place.
You can report success.</p>
</li>
<li><p class="first">When you use the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">Command Submission Service</span></a>,
subscribe with the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">Command Completion Service</span></a> for completions for <code class="docutils literal notranslate"><span class="pre">actAs</span></code> from <code class="docutils literal notranslate"><span class="pre">OFF1</span></code> (exclusive) until you see a completion event for the change ID and the submission ID chosen in <a class="reference internal" href="#dedup-bounded-step-submit"><span class="std std-ref">Step 3</span></a>.
If the completion’s status is <code class="docutils literal notranslate"><span class="pre">OK</span></code>, the ledger change took place and you can report success.
Other status codes should be handled according to <a class="reference internal" href="#dedup-bounded-error-handling"><span class="std std-ref">error handling</span></a>.</p>
<p>This step needs no timeout as the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">Command Submission Service</span></a> acknowledges a submission only if there will eventually be a completion event, unless relevant parts of the system become permanently unavailable.</p>
</li>
</ul>
</li>
</ol>
<div class="section" id="error-handling">
<span id="dedup-bounded-error-handling"></span><h4>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h4>
<p>Error handling is needed when the status code of the command submission RPC call or in the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-completion-status"><span class="std std-ref">completion event</span></a> is not <code class="docutils literal notranslate"><span class="pre">OK</span></code>.
The following table lists appropriate reactions by status code (written as <code class="docutils literal notranslate"><span class="pre">STATUS_CODE</span></code>) and error code (written in capital letters with a link to the error code documentation).
Fields in the error metadata are written as <code class="docutils literal notranslate"><span class="pre">field</span></code> in lowercase letters.</p>
<table border="1" class="colwidths-given docutils align-default" id="id4">
<caption><span class="caption-text">Command deduplication error handling with known processing time bound</span><a class="headerlink" href="#id4" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Error condition</th>
<th class="head">Reaction</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">DEADLINE_EXCEEDED</span></code></td>
<td><p class="first">Consider the submission lost.</p>
<p class="last">Retry from <a class="reference internal" href="#dedup-bounded-step-offset"><span class="std std-ref">Step 2</span></a>, obtaining the completion offset <code class="docutils literal notranslate"><span class="pre">OFF1</span></code>, and possibly increase the timeout.</p>
</td>
</tr>
<tr class="row-odd"><td>Application crashed</td>
<td>Retry from <a class="reference internal" href="#dedup-bounded-step-offset"><span class="std std-ref">Step 2</span></a>, obtaining the completion offset <code class="docutils literal notranslate"><span class="pre">OFF1</span></code>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">ALREADY_EXISTS</span></code> / <a class="reference internal" href="grpc/error-codes.html#error-code-duplicate-command"><span class="std std-ref">DUPLICATE_COMMAND</span></a></td>
<td>The change ID has already been accepted by the ledger within the reported deduplication period.
The optional field <code class="docutils literal notranslate"><span class="pre">completion_offset</span></code> contains the precise offset.
The optional field <code class="docutils literal notranslate"><span class="pre">existing_submission_id</span></code> contains the submission ID of the successful submission.
Report success for the ledger change.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">FAILED_PRECONDITION</span></code> / <a class="reference internal" href="grpc/error-codes.html#error-code-invalid-deduplication-period"><span class="std std-ref">INVALID_DEDUPLICATION_PERIOD</span></a></td>
<td><p class="first">The specified deduplication period is longer than what the Daml ledger supports or the ledger cannot handle the specified deduplication offset.
<code class="docutils literal notranslate"><span class="pre">earliest_offset</span></code> contains the earliest deduplication offset or <code class="docutils literal notranslate"><span class="pre">longest_duration</span></code> contains the longest deduplication duration that can be used (at least one of the two must be provided).</p>
<p>Options:</p>
<ul class="last simple">
<li>Negotiate support for longer deduplication periods with the ledger operator.</li>
<li>Set the deduplication offset to <code class="docutils literal notranslate"><span class="pre">earliest_offset</span></code> or the deduplication duration to <code class="docutils literal notranslate"><span class="pre">longest_duration</span></code> and retry from <a class="reference internal" href="#dedup-bounded-step-offset"><span class="std std-ref">Step 2</span></a>,  obtaining the completion offset <code class="docutils literal notranslate"><span class="pre">OFF1</span></code>.
This may lead to accepting the change twice within the originally intended deduplication period.</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">FAILED_PRECONDITION</span></code> / <a class="reference internal" href="grpc/error-codes.html#error-code-participant-pruned-data-accessed"><span class="std std-ref">PARTICIPANT_PRUNED_DATA_ACCESSED</span></a></td>
<td><p class="first">The specified deduplication offset has been pruned by the participant.
<code class="docutils literal notranslate"><span class="pre">earliest_offset</span></code> contains the last pruned offset.</p>
<blockquote class="last">
<div>Use the <a class="reference internal" href="services.html#command-completion-service"><span class="std std-ref">Command Completion Service</span></a> by asking for the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-completionstreamrequest"><span class="std std-ref">completions</span></a>, starting from the last pruned offset by setting <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-completionstreamrequest-offset"><span class="std std-ref">offset</span></a> to the value of
<code class="docutils literal notranslate"><span class="pre">earliest_offset</span></code>, and use the first received <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-checkpoint-offset"><span class="std std-ref">offset</span></a> as a deduplication offset.</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">ABORTED</span></code> / <a class="reference internal" href="grpc/error-codes.html#error-code-submission-already-in-flight"><span class="std std-ref">SUBMISSION_ALREADY_IN_FLIGHT</span></a></p>
<p class="last">This error occurs only as an RPC response, not inside a completion event.</p>
</td>
<td><p class="first">There is already another submission in flight, with the submission ID in <code class="docutils literal notranslate"><span class="pre">existing_submission_id</span></code>.</p>
<ul class="last">
<li><p class="first">When you use the <a class="reference internal" href="services.html#command-service"><span class="std std-ref">Command Service</span></a>, wait a bit and retry from <a class="reference internal" href="#dedup-bounded-step-submit"><span class="std std-ref">Step 3</span></a>, submitting the command.</p>
<p>Since the in-flight submission might still be rejected, (repeated) resubmission ensures that you (eventually) learn the outcome:
If an earlier submission was accepted, you will eventually receive a <a class="reference internal" href="grpc/error-codes.html#error-code-duplicate-command"><span class="std std-ref">DUPLICATE_COMMAND</span></a> rejection.
Otherwise, you have a second chance to get the ledger change accepted on the ledger and learn the outcome.</p>
</li>
<li><p class="first">When you use the <a class="reference internal" href="services.html#command-completion-service"><span class="std std-ref">Command Completion Service</span></a>, look for a completion for <code class="docutils literal notranslate"><span class="pre">existing_submission_id</span></code> instead of the chosen submission ID in <a class="reference internal" href="#dedup-bounded-step-await"><span class="std std-ref">Step 4</span></a>.</p>
</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">ABORTED</span></code> / other error codes</td>
<td>Wait a bit and retry from <a class="reference internal" href="#dedup-bounded-step-offset"><span class="std std-ref">Step 2</span></a>, obtaining the completion offset <code class="docutils literal notranslate"><span class="pre">OFF1</span></code>.</td>
</tr>
<tr class="row-odd"><td>other error conditions</td>
<td><p class="first">Use background knowledge about the business workflow and the current ledger state to decide whether earlier submissions might still get accepted.</p>
<ul class="simple">
<li>If you conclude that it cannot be accepted any more, stop retrying and report that the ledger change failed.</li>
<li>Otherwise, retry from <a class="reference internal" href="#dedup-bounded-step-offset"><span class="std std-ref">Step 2</span></a>, obtaining a completion offset <code class="docutils literal notranslate"><span class="pre">OFF1</span></code>, or give up without knowing for sure that the ledger change will not happen.</li>
</ul>
<p class="last">For example, if the ledger change only creates a contract instance of a template, you can never be sure, as any outstanding submission might still be accepted on the ledger.
In particular, you must not draw any conclusions from not having received a <a class="reference internal" href="grpc/error-codes.html#error-code-submission-already-in-flight"><span class="std std-ref">SUBMISSION_ALREADY_IN_FLIGHT</span></a> error, because the outstanding submission may be queued somewhere and will reach the relevant processing point only later.</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="failure-scenarios">
<h4>Failure scenarios<a class="headerlink" href="#failure-scenarios" title="Permalink to this headline">¶</a></h4>
<p>The above strategy can fail in the following scenarios:</p>
<ol class="arabic">
<li><p class="first">The bound <code class="docutils literal notranslate"><span class="pre">B</span></code> is too low: The command can be executed multiple times.</p>
<p>Possible causes:</p>
<ul class="simple">
<li>You have retried for longer than the deduplication duration, but never got a meaningful answer, e.g., because the timeout (gRPC deadline) is too short.
For example, this can happen due to long-running Daml interpretation when using the <a class="reference internal" href="services.html#command-service"><span class="std std-ref">Command Service</span></a>.</li>
<li>The application clock drifts significantly from the participant’s or ledger’s clock.</li>
<li>There are unexpected network delays.</li>
<li>Submissions are retried internally in the participant or Daml ledger and those retries do not stop before <code class="docutils literal notranslate"><span class="pre">B</span></code> is over.
Refer to the specific ledger’s documentation for more information.</li>
</ul>
</li>
<li><p class="first">Unacceptable changes cause infinite retries</p>
<p>You need business workflow knowledge to decide that retrying does not make sense any more.
Of course, you can always stop retrying and accept that you do not know the outcome for sure.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="unknown-processing-time-bounds">
<h3>Unknown processing time bounds<a class="headerlink" href="#unknown-processing-time-bounds" title="Permalink to this headline">¶</a></h3>
<p>Finding a good bound <code class="docutils literal notranslate"><span class="pre">B</span></code> on the processing time is hard, and there may still be unforeseen circumstances that delay processing beyond the chosen bound <code class="docutils literal notranslate"><span class="pre">B</span></code>.
You can avoid these problems by using deduplication offsets instead of durations.
An offset defines a point in the history of the ledger and is thus not affected by clock skews and network delays.
Offsets are arguably less intuitive and require more effort by the application developer.
We recommend the following strategy for using deduplication offsets:</p>
<ol class="arabic">
<li><p class="first">Choose a fresh command ID for the ledger change and the <code class="docutils literal notranslate"><span class="pre">actAs</span></code> parties, which (together with the application ID) determine the change ID.
Remember the command ID across application crashes.
(Analogous to <a class="reference internal" href="#dedup-bounded-step-command-id"><span class="std std-ref">Step 1 above</span></a>)</p>
</li>
<li id="dedup-unbounded-step-dedup-offset"><p class="first">Obtain a recent offset <code class="docutils literal notranslate"><span class="pre">OFF0</span></code> on the completion event stream and remember across crashes that you use <code class="docutils literal notranslate"><span class="pre">OFF0</span></code> with the chosen command ID. There are several ways to do so:</p>
<ul>
<li><p class="first">Use the <a class="reference internal" href="services.html#command-completion-service"><span class="std std-ref">Command Completion Service</span></a> by asking for the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-completionendrequest"><span class="std std-ref">current ledger end</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some ledger implementations reject deduplication offsets that do not identify a command completion visible to the submitting parties with the error code id <a class="reference internal" href="grpc/error-codes.html#error-code-invalid-deduplication-period"><span class="std std-ref">INVALID_DEDUPLICATION_PERIOD</span></a>.
In general, the ledger end need not identify a command completion that is visible to the submitting parties.
When running on such a ledger, use the Command Service approach described next.</p>
</div>
</li>
<li><p class="first">Use the <a class="reference internal" href="services.html#command-service"><span class="std std-ref">Command Service</span></a> to obtain a recent offset by repeatedly submitting a dummy command, e.g., a <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-createandexercisecommand"><span class="std std-ref">Create-And-Exercise command</span></a> of some single-signatory template with the <a class="reference internal" href="../daml/stdlib/Prelude.html#function-da-internal-template-functions-archive-2977"><span class="std std-ref">Archive</span></a> choice, until you get a successful response.
The response contains the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-submitandwaitfortransactionidresponse-completion-offset"><span class="std std-ref">completion offset</span></a>.</p>
</li>
</ul>
</li>
<li id="dedup-unbounded-step-offset"><p class="first">When you use the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">Command Completion Service</span></a>:</p>
<ul class="simple">
<li>If you execute this step the first time, set <code class="docutils literal notranslate"><span class="pre">OFF1</span> <span class="pre">=</span> <span class="pre">OFF0</span></code>.</li>
<li>If you execute this step as part of <a class="reference internal" href="#dedup-unbounded-error-handling"><span class="std std-ref">error handling</span></a> retrying from Step 3, obtaining the completion offset <code class="docutils literal notranslate"><span class="pre">OFF1</span></code>,
obtain a recent offset on the completion stream <code class="docutils literal notranslate"><span class="pre">OFF1</span></code>, say its current end.
(Analogous to <a class="reference internal" href="#dedup-bounded-step-offset"><span class="std std-ref">step 2 above</span></a>)</li>
</ul>
</li>
<li><p class="first">Submit the command with the following parameters (analogous to <a class="reference internal" href="#dedup-bounded-step-submit"><span class="std std-ref">Step 3 above</span></a> except for the deduplication period):</p>
<ul class="simple">
<li>Set the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-command-id"><span class="std std-ref">command ID</span></a> to the chosen command ID from <a class="reference internal" href="#dedup-bounded-step-command-id"><span class="std std-ref">Step 1</span></a>.</li>
<li>Set the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-deduplication-offset"><span class="std std-ref">deduplication offset</span></a> to <code class="docutils literal notranslate"><span class="pre">OFF0</span></code>.</li>
<li>Set the <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-commands-submission-id"><span class="std std-ref">submission ID</span></a> to a fresh value, e.g., a random UUID.</li>
<li>Set the timeout (gRPC deadline) to the expected submission processing time (Command Service) or submission hand-off time (Command Submission Service).</li>
</ul>
</li>
<li><p class="first">Wait until the RPC call returns a response.</p>
<ul class="simple">
<li>Status codes other than <code class="docutils literal notranslate"><span class="pre">OK</span></code> should be handled according to <a class="reference internal" href="#dedup-bounded-error-handling"><span class="std std-ref">error handling</span></a>.</li>
<li>When you use the <a class="reference internal" href="services.html#command-service"><span class="std std-ref">Command Service</span></a> and the response carries the status code <code class="docutils literal notranslate"><span class="pre">OK</span></code>, the ledger change took place.
You can report success.
The response contains a <a class="reference internal" href="grpc/proto-docs.html#com-daml-ledger-api-v1-submitandwaitfortransactionidresponse-completion-offset"><span class="std std-ref">completion offset</span></a> that you can use in <a class="reference internal" href="#dedup-unbounded-step-dedup-offset"><span class="std std-ref">Step 2</span></a> of later submissions.</li>
<li>When you use the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">Command Submission Service</span></a>,
subscribe with the <a class="reference internal" href="services.html#command-submission-service"><span class="std std-ref">Command Completion Service</span></a> for completions for <code class="docutils literal notranslate"><span class="pre">actAs</span></code> from <code class="docutils literal notranslate"><span class="pre">OFF1</span></code> (exclusive) until you see a completion event for the change ID and the submission ID chosen in <a class="reference internal" href="#dedup-bounded-step-submit"><span class="std std-ref">step 3</span></a>.
If the completion’s status is <code class="docutils literal notranslate"><span class="pre">OK</span></code>, the ledger change took place and you can report success.
Other status codes should be handled according to <a class="reference internal" href="#dedup-bounded-error-handling"><span class="std std-ref">error handling</span></a>.</li>
</ul>
</li>
</ol>
<div class="section" id="dedup-unbounded-error-handling">
<span id="id2"></span><h4>Error handling<a class="headerlink" href="#dedup-unbounded-error-handling" title="Permalink to this headline">¶</a></h4>
<p>The same as <a class="reference internal" href="#dedup-bounded-error-handling"><span class="std std-ref">for known bounds</span></a>, except that the former retry from <a class="reference internal" href="#dedup-bounded-step-offset"><span class="std std-ref">Step 2</span></a> becomes retry from <a class="reference internal" href="#dedup-unbounded-step-offset"><span class="std std-ref">Step 3</span></a>.</p>
</div>
<div class="section" id="id3">
<h4>Failure scenarios<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>The above strategy can fail in the following scenarios:</p>
<ol class="arabic">
<li><p class="first">No success within the supported deduplication period</p>
<p>When the application receives a <a class="reference internal" href="grpc/error-codes.html#error-code-invalid-deduplication-period"><span class="std std-ref">INVALID_DEDUPLICATION_PERIOD</span></a> error, it cannot achieve exactly once execution any more within the originally intended deduplication period.</p>
</li>
<li><p class="first">Unacceptable changes cause infinite retries</p>
<p>You need business workflow knowledge to decide that retrying does not make sense any more.
Of course, you can always stop retrying and accept that you do not know the outcome for sure.</p>
</li>
</ol>
</div>
</div>
</div>
</div>


              
            </div>
            
            
              <!-- Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="bindings-x-lang/index.html" class="da-btn da-btn-label btn-prev" title="Creating your own bindings" accesskey="p" rel="prev">Previous</a>
      
      
        <a href="../triggers/index.html" class="da-btn da-btn-label btn-next" title="Daml Triggers - Off-Ledger Automation in Daml" accesskey="n" rel="next">Next</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. Any unauthorized use, duplication or distribution is strictly prohibited. &#34;Digital Asset&#34; and &#34;Daml&#34; are Registered in the U.S. Patent and Trademark Office.

    </p>
  </div> 

</footer>
            
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->





  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.Navigation.enable(true);
      });
  </script>


  
    
  
  <div id="inpageContent"></div>
  

</body>
</html>